<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>

<body>

<h2 align="center">torchjs20.html - Self-Attention Heatmap</h2>

<div style="font-size:15px; background-color:lightyellow; width:88%; border:5px solid blue; padding:5px; margin:5px;"> 
<b>Step 20 Logic:</b> Self-Attention.<br>
<b>Instructions:</b> Type a sentence. Click any word in the "Attention Grid" to see how the AI connects it to other words!
</div><br>

<div id="myCodeSpace">
  <div style="padding: 10px; border: 2px solid green;">
    <b>1. Type a Sentence:</b><br>
    <input type="text" id="myInputText" value="The robot is happy because it works" style="width: 95%; font-size: 18px;" oninput="myProcessAttention()">
  </div>

  <div style="display: flex; gap: 20px; padding: 10px; flex-wrap: wrap;">
    <div style="flex: 1.5; min-width: 300px; border: 2px solid blue; padding: 10px;">
      <b>2. Attention Map (Click a word):</b><br><br>
      <div id="myAttentionGrid" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
    </div>

    <div id="myDivHistory" style="flex: 1; min-width: 250px; border: 2px solid orange; padding: 10px; font-family: monospace; background-color: #f0f8ff;">
      Click a word to see its "Focus".
    </div>
  </div>

  <script>
    // Descriptive names and simple JS as requested
    async function myProcessAttention() {
      const myText = document.getElementById('myInputText').value;
      const myWords = myText.split(/\s+/).filter(w => w.length > 0);
      const myGrid = document.getElementById('myAttentionGrid');
      myGrid.innerHTML = "";

      myWords.forEach((myWord, myIdx) => {
        let myBtn = document.createElement('button');
        myBtn.innerHTML = myWord;
        myBtn.style.padding = "10px";
        myBtn.style.fontSize = "16px";
        myBtn.style.cursor = "pointer";
        // Static link to function instead of event listener
        myBtn.onclick = function() { myShowFocus(myIdx, myWords); };
        myGrid.appendChild(myBtn);
      });
    }

    async function myShowFocus(myFocusIdx, myAllWords) {
      const myGridBtns = document.getElementById('myAttentionGrid').children;
      const myHistory = document.getElementById('myDivHistory');
      const myTargetWord = myAllWords[myFocusIdx];
      
      let myFocusData = [];
      let myTotalText = `<b>AI Focus for "${myTargetWord}":</b><br><br>`;

      // Simulate a Self-Attention Score (Dot Product Similarity)
      // In a real model, this uses the Query and Key vectors
      myAllWords.forEach((w, i) => {
        // Mock logic: "it" attends to "robot", "happy" attends to "robot"
        let myScore = 0.1; // Baseline
        if (i === myFocusIdx) myScore = 0.9; // Self-attention is always high
        
        // Logical connections for students to see
        if (myTargetWord === "it" && w === "robot") myScore = 0.8;
        if (myTargetWord === "works" && w === "robot") myScore = 0.7;
        if (myTargetWord === "happy" && w === "robot") myScore = 0.6;

        myFocusData.push(myScore);
        
        // Color the buttons based on the focus score (Heatmap style)
        myGridBtns[i].style.backgroundColor = `rgba(255, 165, 0, ${myScore})`;
        myTotalText += `${w}: ${(myScore * 100).toFixed(0)}% focus<br>`;
      });

      myHistory.innerHTML = myTotalText;
      
      // Show the student the Attention Vector as a Tensor
      const myAttentionTensor = tf.tensor1d(myFocusData);
      myHistory.innerHTML += `<br><b>Tensor:</b> [${myFocusData.join(", ")}]`;
      myAttentionTensor.dispose();
    }

    window.onload = myProcessAttention;
  </script>
</div>

<textarea id="myTextarea1" wrap="off" rows="2" style="width:95%; background:black; color:white; font-family:monospace; margin:10px;" onclick="myTextGrow('myTextarea1', 'myCodeSpace')">
Click to see the Attention Mechanism source code...
</textarea>

<script>
function myTextGrow(myT, myC) {
   const myArea = document.getElementById(myT);
   const myPrefix = '\x3Cscript src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0">\x3C/script>\n\n';
   myArea.value = myPrefix + document.getElementById(myC).innerHTML;
   myArea.rows = myArea.value.split('\n').length + 3;
}
</script>

</body>