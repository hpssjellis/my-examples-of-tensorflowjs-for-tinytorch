<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>

<body>

<h2 align="center">torchjs20.html - Stable Attention Heatmap</h2>

<div style="font-size:15px; background-color:lightyellow; width:88%; border:5px solid blue; padding:5px; margin:5px;"> 
<b>Self-Attention:</b> Type a sentence below. Click a word in the grid to see how much "Attention" the AI pays to every other word. 
Use <b>Update and Run</b> to change the scoring logic!
</div><br>

<div id="myCodeSpace">
  <div style="padding: 10px; border: 2px solid green;">
    <b>1. Type a Sentence:</b><br>
    <input type="text" id="myInputText" value="The robot is happy because it works" style="width: 95%; font-size: 18px;" oninput="myProcessAttention()">
  </div>

  <div style="display: flex; gap: 20px; padding: 10px; flex-wrap: wrap;">
    <div style="flex: 1.5; min-width: 300px; border: 2px solid blue; padding: 10px;">
      <b>2. Attention Grid (Click to focus):</b><br><br>
      <div id="myAttentionGrid" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
    </div>

    <div style="flex: 1; min-width: 300px; border: 2px solid orange; padding: 10px;">
      <b>3. Attention Scores:</b><br>
      <div id="myDivHistory" style="font-family: monospace; font-size: 14px; background: #fff4e6; padding: 5px;"></div>
    </div>
  </div>

  <script>
    var myTargetIndex = 5; // Default focus on "it"

    function myProcessAttention() {
      const myInput = document.getElementById('myInputText').value;
      const myGrid = document.getElementById('myAttentionGrid');
      const myHistory = document.getElementById('myDivHistory');
      
      const myWords = myInput.split(/\s+/).filter(x => x.length > 0);
      myGrid.innerHTML = "";
      let myTotalText = "";
      let myFocusData = [];

      myWords.forEach((w, i) => {
        const myBtn = document.createElement('input');
        myBtn.type = "button";
        myBtn.value = w;
        myBtn.style.padding = "10px";
        myBtn.style.fontSize = "16px";
        myBtn.style.cursor = "pointer";
        myBtn.style.border = (i === myTargetIndex) ? "3px solid red" : "1px solid gray";
        
        // Change focus when clicked
        myBtn.onclick = () => { myTargetIndex = i; myProcessAttention(); };
        myGrid.appendChild(myBtn);

        // --- SIMULATED ATTENTION LOGIC ---
        // Students can edit these rules to see how the heatmap changes
        let myScore = 0.1; 
        const myTargetWord = myWords[myTargetIndex]?.toLowerCase();
        const myCurrentWord = w.toLowerCase();

        if (i === myTargetIndex) myScore = 1.0; // Self-focus is always 100%
        
        // Logic: Connect "it" to the Subject
        if (myTargetWord === "it" && (myCurrentWord === "robot" || myCurrentWord === "the")) myScore = 0.8;
        if (myTargetWord === "works" && myCurrentWord === "robot") myScore = 0.7;
        if (myTargetWord === "happy" && (myCurrentWord === "robot" || myCurrentWord === "is")) myScore = 0.6;

        myFocusData.push(myScore.toFixed(2));
        myBtn.style.backgroundColor = `rgba(255, 165, 0, ${myScore})`; // Orange Heatmap
        myTotalText += `<b>${w}:</b> ${(myScore * 100).toFixed(0)}% focus<br>`;
      });

      myHistory.innerHTML = `Focusing on: <b>${myWords[myTargetIndex]}</b><br><br>` + myTotalText;
      
      // Visualize as a Tensor
      const myTensor = tf.tensor1d(myFocusData.map(Number));
      myHistory.innerHTML += `<br><b>Attention Tensor:</b><br>[${myFocusData.join(", ")}]`;
      myTensor.dispose();
    }
  </script>
</div>

<input id="myUpdateBtn" type="button" value="Update and Run" style="visibility:hidden; background-color: yellow;" onclick="myApplyAndRun()"><br>

<textarea id="myTextarea1" wrap="off" rows="2" style="width:95%; background:black; color:white; font-family:monospace; margin:10px;" onclick="myToggleEditor()">
Click here to see the Attention Mechanism code...
</textarea>

<script>
let myOnce = true;

function myToggleEditor() {
    if (myOnce) {
       myTextGrow('myTextarea1', 'myCodeSpace');
       document.getElementById('myUpdateBtn').style.visibility = 'visible';
       myOnce = false;
    }
}

function myApplyAndRun() {
  let myLines = document.getElementById('myTextarea1').value.split('\n');
  myLines.shift(); // Remove script
  myLines.shift(); // Remove spacer
  myLines.pop();   // Remove div
  
  document.getElementById('myCodeSpace').innerHTML = myLines.join('\n');
  myProcessAttention(); 
}

function myTextGrow(myT, myC) {
   const myArea = document.getElementById(myT);
   myArea.value = '\x3Cscript src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0">\x3C/script>\n\n' + document.getElementById(myC).innerHTML;
   myArea.value += "\n<div id='myDivHistory'>...</div>";
   setTimeout(() => { myArea.rows = myArea.value.split('\n').length + 3; }, 100);
}

window.onload = myProcessAttention;
</script>

</body>