#include "esp_camera.h"
#include "EloquentTinyML.h"
#include "eloquent_tinyml/tensorflow/librt.h" // New LiteRT Bridge
#include "myWeights.h"  // Your exported weights

// 1. Model Configuration
#define MY_INPUTS 4096  // 64x64 pixels
#define MY_OUTPUTS 3    // 3 Classes
#define MY_TENSOR_ARENA_SIZE 80 * 1024

// 2. Camera Pin Definitions (XIAO ESP32-S3 Sense / Standard S3)
#define PWDN_GPIO_NUM     -1
#define RESET_GPIO_NUM    -1
#define XCLK_GPIO_NUM     10
#define SIOD_GPIO_NUM     40
#define SIOC_GPIO_NUM     39
#define Y9_GPIO_NUM       48
#define Y8_GPIO_NUM       11
#define Y7_GPIO_NUM       12
#define Y6_GPIO_NUM       14
#define Y5_GPIO_NUM       16
#define Y4_GPIO_NUM       18
#define Y3_GPIO_NUM       17
#define Y2_GPIO_NUM       15
#define VSYNC_GPIO_NUM    38
#define HREF_GPIO_NUM     47
#define PCLK_GPIO_NUM     13

// Initialize the Brain
Eloquent::TinyML::TfLite<MY_INPUTS, MY_OUTPUTS, MY_TENSOR_ARENA_SIZE> myBrain;

void setup() {
    Serial.begin(115200);
    
    // 3. Standard Camera Config
    camera_config_t myConfig;
    myConfig.ledc_channel = LEDC_CHANNEL_0;
    myConfig.ledc_timer = LEDC_TIMER_0;
    myConfig.pin_d0 = Y2_GPIO_NUM;
    myConfig.pin_d1 = Y3_GPIO_NUM;
    myConfig.pin_d2 = Y4_GPIO_NUM;
    myConfig.pin_d3 = Y5_GPIO_NUM;
    myConfig.pin_d4 = Y6_GPIO_NUM;
    myConfig.pin_d5 = Y7_GPIO_NUM;
    myConfig.pin_d6 = Y8_GPIO_NUM;
    myConfig.pin_d7 = Y9_GPIO_NUM;
    myConfig.pin_xclk = XCLK_GPIO_NUM;
    myConfig.pin_pclk = PCLK_GPIO_NUM;
    myConfig.pin_vsync = VSYNC_GPIO_NUM;
    myConfig.pin_href = HREF_GPIO_NUM;
    myConfig.pin_sscb_sda = SIOD_GPIO_NUM;
    myConfig.pin_sscb_scl = SIOC_GPIO_NUM;
    myConfig.pin_pwdn = PWDN_GPIO_NUM;
    myConfig.pin_reset = RESET_GPIO_NUM;
    myConfig.xclk_freq_hz = 20000000;
    myConfig.frame_size = FRAMESIZE_QQVGA; // 160x120
    myConfig.pixel_format = PIXFORMAT_GRAYSCALE; // Simple for students
    myConfig.grab_mode = CAMERA_GRAB_WHEN_EMPTY;
    myConfig.fb_location = CAMERA_FB_IN_PSRAM;
    myConfig.fb_count = 1;

    esp_err_t myErr = esp_camera_init(&myConfig);
    if (myErr != ESP_OK) {
        Serial.println("Camera Init Failed!");
        return;
    }

    // 4. Load the LiteRT model
    myBrain.begin(myWeights_w); 
    Serial.println("System Ready!");
}

void loop() {
    // 5. Capture Image
    camera_fb_t * myFrame = esp_camera_fb_get();
    if (!myFrame) return;

    // 6. Pre-process (Standard Pixel Unpacking)
    float myInput[MY_INPUTS];
    for (int i = 0; i < MY_INPUTS; i++) {
        // We take every few pixels to downsample 160x120 to 64x64 roughly
        myInput[i] = (float)myFrame->buf[i] / 255.0f;
    }

    // 7. Prediction
    int myClass = myBrain.predictClass(myInput);
    float myProb = myBrain.getProbability();

    Serial.print("I see Class: ");
    Serial.print(myClass);
    Serial.print(" Confidence: ");
    Serial.println(myProb);

    esp_camera_fb_return(myFrame);
    delay(500);
}