<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>

<body>

<h2 align="center">torchjs24.html - Stable Performance Benchmarker</h2>

<div style="font-size:15px; background-color:lightyellow; width:88%; border:5px solid blue; padding:5px; margin:5px;"> 
<b>Step 24 Logic:</b> Profiling & Benchmarking.<br>
<b>Update and Run:</b> This button now correctly refreshes the logic and re-triggers the benchmark loop automatically.
</div><br>

<div id="myCodeSpace">
  <div style="display: flex; gap: 20px; padding: 10px; flex-wrap: wrap;">
    
    <div style="flex: 1; min-width: 300px; border: 2px solid green; padding: 10px; text-align: center;">
      <video id="myVideo1" width="320" height="240" autoplay playsinline style="border:1px solid black; background: #333;"></video><br><br>
      <input type="button" value="1. Start Benchmark" onclick="myStartBenchmark()" style="font-size:18px; padding:10px;">
    </div>

    <div style="flex: 1; min-width: 300px; border: 2px solid blue; padding: 10px;">
      <b>AI Stats:</b><br><br>
      <div style="font-size: 20px; font-family: monospace;">
        FPS: <span id="myFPS" style="color:red; font-weight:bold;">0</span><br>
        Latency: <span id="myLatency" style="color:blue; font-weight:bold;">0</span> ms<br>
      </div>
      <hr>
      <b>Simulate Brain Complexity:</b><br>
      <input type="range" id="myComplexity" min="1" max="100" value="10" style="width:90%;" oninput="myDrawStatus()"> 
      <br> (Slide to add/remove fake neural layers)
    </div>
  </div>

  <div id="myDivHistory" style="border: 2px solid orange; padding: 10px; margin: 10px; font-family: monospace; background-color: #f0f8ff; min-height: 60px;">
    Click "Start Benchmark" to begin...
  </div>

  <script>
    let myIsRunning = false;

    async function myStartBenchmark() {
      const myVideo = document.getElementById('myVideo1');
      try {
        // Only request stream if not already active
        if (!myVideo.srcObject) {
          const myStream = await navigator.mediaDevices.getUserMedia({video: true});
          myVideo.srcObject = myStream;
        }
        myIsRunning = true;
        myLoop();
      } catch(e) {
        alert("Camera Error: " + e.message);
      }
    }

    async function myLoop() {
      if (!myIsRunning) return;
      const myVideo = document.getElementById('myVideo1');

      // CRITICAL FIX: Only run if the video is ready
      if (myVideo.readyState === 4) {
        const myStart = performance.now();
        const myComplexity = document.getElementById('myComplexity').value;

        // 1. Process Frame
        const myFrame = tf.browser.fromPixels(myVideo).resizeBilinear([64, 64]).div(255.0).expandDims(0);

        // 2. Simulate Layer Complexity
        let myLogic = myFrame;
        for(let i=0; i < myComplexity; i++) {
          myLogic = tf.add(myLogic, 0.0001); 
        }

        // 3. Force synchronization
        await myLogic.data(); 

        const myEnd = performance.now();
        const myDiff = (myEnd - myStart);
        
        document.getElementById('myLatency').innerHTML = myDiff.toFixed(1);
        document.getElementById('myFPS').innerHTML = (1000 / myDiff).toFixed(1);

        // Memory Management
        myFrame.dispose();
        myLogic.dispose();
      }
      requestAnimationFrame(myLoop);
    }

    function myDrawStatus() {
       document.getElementById('myDivHistory').innerHTML = `<b>Benchmarking:</b> Simulating ${document.getElementById('myComplexity').value} model layers...`;
    }
  </script>
</div>

<input id="myUpdateBtn" type="button" value="Update and Run" style="visibility:hidden; background-color: yellow; margin-left: 10px;" onclick="myApplyAndRun()"><br>

<textarea id="myTextarea1" wrap="off" rows="2" style="width:95%; background:black; color:white; font-family:monospace; margin:10px;" onclick="myToggleEditor()">
Click here to see the performance math...
</textarea>

<script>
let myOnce = true;

function myToggleEditor() {
    if (myOnce) {
       myTextGrow('myTextarea1', 'myCodeSpace');
       document.getElementById('myUpdateBtn').style.visibility = 'visible';
       myOnce = false;
    }
}

function myApplyAndRun() {
  let myArea = document.getElementById('myTextarea1');
  let myLines = myArea.value.split('\n');
  
  // Strip the wrapper markers
  myLines.shift(); // remove script tag
  myLines.shift(); // remove spacer
  myLines.pop();   // remove div history
  
  document.getElementById('myCodeSpace').innerHTML = myLines.join('\n');
  
  // FIX: Re-trigger the benchmark immediately after updating the code
  myStartBenchmark(); 
}

function myTextGrow(myT, myC) {
   const myArea = document.getElementById(myT);
   const myPrefix = '\x3Cscript src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0">\x3C/script>\n\n';
   myArea.value = myPrefix + document.getElementById(myC).innerHTML;
   myArea.value += "\n<div id='myDivHistory'>...</div>";
   setTimeout(() => { myArea.rows = myArea.value.split('\n').length + 3; }, 100);
}
</script>

</body>