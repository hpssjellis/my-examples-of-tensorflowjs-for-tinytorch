<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>

<body>

<h2 align="center">torchjs24.html - Performance Benchmarker</h2>

<div style="font-size:15px; background-color:lightyellow; width:88%; border:5px solid blue; padding:5px; margin:5px;"> 
<b>Step 24 Logic:</b> Profiling & Benchmarking.<br>
<b>Fixed:</b> Added <code>readyState</code> check to prevent <i>IndexSizeError</i> on startup.<br>
<b>Instructions:</b> Start the camera. Adjust complexity to see how many "Layers" your device can handle!
</div><br>

<div id="myCodeSpace">
  <div style="display: flex; gap: 20px; padding: 10px; flex-wrap: wrap;">
    
    <div style="flex: 1; min-width: 300px; border: 2px solid green; padding: 10px; text-align: center;">
      <video id="myVideo1" width="320" height="240" autoplay playsinline style="border:1px solid black;"></video><br>
      <input type="button" value="Start Benchmark" onclick="myStartBenchmark()" style="font-size:18px; padding:10px;">
    </div>

    <div style="flex: 1; min-width: 300px; border: 2px solid blue; padding: 10px;">
      <b>AI Stats:</b><br><br>
      <div style="font-size: 20px; font-family: monospace;">
        FPS: <span id="myFPS" style="color:red; font-weight:bold;">0</span><br>
        Latency: <span id="myLatency" style="color:blue; font-weight:bold;">0</span> ms<br>
      </div>
      <hr>
      <b>Simulate Brain Complexity:</b><br>
      <input type="range" id="myComplexity" min="1" max="100" value="10" style="width:90%;" oninput="myDrawStatus()"> 
      <br> (Slide to add/remove fake neural layers)
    </div>
  </div>

  <div id="myDivHistory" style="border: 2px solid orange; padding: 10px; margin: 10px; font-family: monospace; background-color: #f0f8ff; min-height: 60px;">
    Click "Start Benchmark" to begin...
  </div>

  <script>
    // Descriptive names and simple JS
    let myIsRunning = false;

    async function myStartBenchmark() {
      try {
        const myStream = await navigator.mediaDevices.getUserMedia({video: true});
        document.getElementById('myVideo1').srcObject = myStream;
        myIsRunning = true;
        myLoop();
      } catch(e) {
        alert("Camera Error: " + e.message);
      }
    }

    async function myLoop() {
      if (!myIsRunning) return;
      
      const myVideo = document.getElementById('myVideo1');

      // CRITICAL FIX: Only run if the video is ready and has dimensions
      if (myVideo.readyState < 2 || myVideo.videoWidth === 0) {
        requestAnimationFrame(myLoop);
        return; 
      }

      const myStart = performance.now();
      const myComplexity = document.getElementById('myComplexity').value;

      // 1. Process Frame
      const myFrame = tf.browser.fromPixels(myVideo).resizeBilinear([64, 64]).div(255.0).expandDims(0);

      // 2. Simulate Layer Complexity
      // We perform math operations repeatedly to simulate a deeper model
      let myLogic = myFrame;
      for(let i=0; i < myComplexity; i++) {
        myLogic = tf.add(myLogic, 0.0001); 
      }

      // 3. Force synchronization to get accurate timing
      await myLogic.data(); 

      const myEnd = performance.now();
      const myDiff = (myEnd - myStart);
      
      document.getElementById('myLatency').innerHTML = myDiff.toFixed(1);
      document.getElementById('myFPS').innerHTML = (1000 / myDiff).toFixed(1);

      // Memory Management
      myFrame.dispose();
      myLogic.dispose();

      requestAnimationFrame(myLoop);
    }

    function myDrawStatus() {
       document.getElementById('myDivHistory').innerHTML = `<b>Benchmarking:</b> Simulating ${document.getElementById('myComplexity').value} model layers...`;
    }
  </script>
</div>

<textarea id="myTextarea1" wrap="off" rows="2" style="width:95%; background:black; color:white; font-family:monospace; margin:10px;" onclick="myTextGrow('myTextarea1', 'myCodeSpace')">
Click to see the performance math and IndexSizeError fix...
</textarea>

<script>
// Captures everything in myCodeSpace including history and scripts
function myTextGrow(myT, myC) {
   const myArea = document.getElementById(myT);
   const myPrefix = '\x3Cscript src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0">\x3C/script>\n\n';
   myArea.value = myPrefix + document.getElementById(myC).innerHTML;
   myArea.rows = myArea.value.split('\n').length + 3;
}
</script>

</body>