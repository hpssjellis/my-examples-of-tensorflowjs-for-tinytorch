<!DOCTYPE html>
<html>
<head>
    <title>Rocksetta Pro: Unified Optimizer</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>
</head>
<body style="font-family: sans-serif; background-color: #fdfdfd; padding: 20px;">

<h2 align="center">Rocksetta Pro: Unified 240x240 Optimizer</h2>

<div style="font-size:14px; background-color:lightyellow; width:92%; border:2px solid blue; padding:15px; margin:auto; border-radius:10px; margin-bottom: 20px;"> 
    <b>Instructions:</b> Capture at least 20 frames per class. Use the checkbox to toggle between <b>Float32</b> (Standard) or <b>Int8</b> (Compressed) for your ESP32-S3.
</div>

<div id="myCodeSpace"> 
  <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; padding: 10px;">
    
    <div style="flex: 1; min-width: 350px; border: 1px solid #ccc; padding: 15px; background: white; border-radius: 10px;">
      <select id="myCameraSelect" style="width: 100%; margin-bottom: 5px; padding: 5px;"></select>
      <div align="center">
          <video id="myVideo1" width="240" height="240" autoplay playsinline style="border: 2px solid black; background: #000; border-radius: 5px;"></video>
      </div>
      <br>
      <input type="button" value="1. Start Camera & Brain" onclick="myStartAll()" style="width:100%; font-weight:bold; padding:12px; background:#e1f5fe; border-radius: 5px; cursor:pointer;">
      <hr>
      <div style="display: flex; justify-content: space-between;">
          <input type="button" value="Save TFJS Model" onclick="mySaveModel()" style="width:48%; padding: 8px;">
          <input type="button" value="Load TFJS Model" onclick="myLoadModel()" style="width:48%; padding: 8px;">
      </div>
      <hr>
      <b>Training Labels:</b><br>
      <div style="display: flex; justify-content: space-between; margin-top:5px; text-align:center; font-size:12px;">
        <div><input type="button" value="Train 0" onclick="myCollect(0)" style="padding:10px;"><br><input type="text" id="myLabel0" value="Background" size="9" style="margin-top:5px;"></div>
        <div><input type="button" value="Train 1" onclick="myCollect(1)" style="padding:10px;"><br><input type="text" id="myLabel1" value="Target A" size="9" style="margin-top:5px;"></div>
        <div><input type="button" value="Train 2" onclick="myCollect(2)" style="padding:10px;"><br><input type="text" id="myLabel2" value="Target B" size="9" style="margin-top:5px;"></div>
      </div>
    </div>

    <div style="flex: 1; min-width: 350px; border: 2px solid green; padding: 15px; background: #f1f8e9; border-radius: 10px;">
      <b>2. Edge AI Export Settings</b><hr>
      
      <label style="font-weight: bold; color: darkgreen; cursor: pointer;">
        <input type="checkbox" id="myInt8Toggle"> Use Int8 Quantization (Saves Memory)
      </label>
      <p style="font-size: 12px; color: #555;"><i>Checking this converts Floats to 1-byte Integers.</i></p>

      <b>File Name:</b><br>
      <input type="text" id="myExportName" value="myModel" style="width:70%; padding: 5px;"> .h
      <br><br>
      <input type="button" value="GENERATE C-HEADER (.h)" style="background-color:#4CAF50; color:white; width:100%; padding:15px; font-weight:bold; border: none; border-radius: 5px; cursor:pointer;" onclick="myExportHeader()">
      <hr>
      <div id="myDiv1" style="border: 1px solid green; padding: 10px; font-family: monospace; background: white; min-height: 50px; border-radius: 5px;">Ready...</div>
    </div>

    <div style="flex: 1; min-width: 350px; border: 1px solid #ccc; padding: 15px; background: white; border-radius: 10px;">
      <b>3. Activity Logs</b><hr>
      <div id="myDivHistory" style="border: 1px solid blue; padding: 8px; height: 300px; overflow-y: scroll; font-family: monospace; font-size: 0.85em; background: #f1f8ff; border-radius: 5px;">Logs...</div>
    </div>
  </div>

  <script>
    var myModel, myTimer, myLastID = -1;
    var myTrainData = {0:[], 1:[], 2:[]};
    var myReplaceIndex = {0:0, 1:0, 2:0}; 
    var myMaxBuffer = 20;

    async function myStartAll() {
      const myVideo = document.getElementById('myVideo1');
      if (!myVideo.srcObject) {
        const myDeviceId = document.getElementById('myCameraSelect').value;
        myVideo.srcObject = await navigator.mediaDevices.getUserMedia({
            video: { width: 240, height: 240, deviceId: myDeviceId ? { exact: myDeviceId } : undefined }
        });
      }
      
      if (!myModel) {
        myModel = tf.sequential();
        myModel.add(tf.layers.conv2d({inputShape:[64,64,3], kernelSize:3, filters:4, activation:'relu', padding:'valid'}));
        myModel.add(tf.layers.flatten());
        myModel.add(tf.layers.dense({units:3, activation:'softmax'}));
        myModel.compile({optimizer: tf.train.adam(0.005), loss:'categoricalCrossentropy'});
        document.getElementById('myDivHistory').innerHTML = "Brain Initialized!<br>" + document.getElementById('myDivHistory').innerHTML;
      }

      if (myTimer) clearInterval(myTimer);
      myTimer = setInterval(async () => {
        const myInput = tf.browser.fromPixels(myVideo).resizeBilinear([64,64]).div(255.0).expandDims(0);
        
        if (myTrainData[0].length > 0 && myTrainData[1].length > 0 && myTrainData[2].length > 0) {
          const myBatch = tf.concat([
            myTrainData[0][Math.floor(Math.random()*myTrainData[0].length)],
            myTrainData[1][Math.floor(Math.random()*myTrainData[1].length)],
            myTrainData[2][Math.floor(Math.random()*myTrainData[2].length)]
          ]);
          await myModel.trainOnBatch(myBatch, tf.tensor2d([[1,0,0],[0,1,0],[0,0,1]]));
          myBatch.dispose();
        }

        const myPred = myModel.predict(myInput);
        const myID = (await myPred.argMax(1).data())[0];
        const myLabel = document.getElementById('myLabel' + myID).value;
        document.getElementById('myDiv1').innerHTML = `DETECTED: <b>${myLabel}</b><br>Buffers: ${myTrainData[0].length}, ${myTrainData[1].length}, ${myTrainData[2].length}`;
        
        if (myID !== myLastID) {
          document.getElementById('myDivHistory').innerHTML = `[${new Date().toLocaleTimeString()}] -> ${myLabel}<br>` + document.getElementById('myDivHistory').innerHTML;
          myLastID = myID;
        }
        myInput.dispose(); myPred.dispose();
      }, 150);
    }

    async function myExportHeader() {
      if(!myModel) { alert("Start the brain first!"); return; }
      const isInt8 = document.getElementById('myInt8Toggle').checked;
      
      let myText = `// Model: ${isInt8 ? "INT8 Quantized" : "Float32"}\n`;
      myText += `#ifndef MY_MODEL_H\n#define MY_MODEL_H\n\n`;
      
      if (isInt8) {
          myText += `#define USE_INT8_MODE\n\n`;
      }

      const myNames = ["myConv1_w", "myConv1_b", "myOutput_w", "myOutput_b"];
      let myNameIndex = 0;

      for (let i = 0; i < myModel.layers.length; i++) {
          const myWeights = myModel.layers[i].getWeights();
          for (let j = 0; j < myWeights.length; j++) {
              let myData = await myWeights[j].data();
              let myType = isInt8 ? "int8_t" : "float";

              if (isInt8) {
                  const myMax = Math.max(...Array.from(myData).map(Math.abs));
                  const myScale = 127.0 / (myMax || 1);
                  myText += `const float ${myNames[myNameIndex]}_scale = ${myScale.toFixed(6)}f;\n`;
                  myText += `const ${myType} ${myNames[myNameIndex]}[] = { `;
                  myText += Array.from(myData).map(v => Math.round(v * myScale)).join(', ');
              } else {
                  myText += `const ${myType} ${myNames[myNameIndex]}[] = { `;
                  myText += Array.from(myData).map(v => v.toFixed(6)).join(', ');
              }
              myText += ` };\n\n`;
              myNameIndex++;
          }
      }
      myText += `#endif`;

      const myLink = document.createElement('a');
      myLink.href = URL.createObjectURL(new Blob([myText]));
      myLink.download = document.getElementById('myExportName').value + ".h";
      myLink.click();
      document.getElementById('myDivHistory').innerHTML = "C-Header Exported!<br>" + document.getElementById('myDivHistory').innerHTML;
    }

    function myCollect(myID) {
      const myVideo = document.getElementById('myVideo1');
      const myFrame = tf.browser.fromPixels(myVideo).resizeBilinear([64,64]).div(255.0).expandDims(0);
      let mySlot = myReplaceIndex[myID];
      if (myTrainData[myID].length < myMaxBuffer) { myTrainData[myID].push(myFrame); } 
      else { myTrainData[myID][mySlot].dispose(); myTrainData[myID][mySlot] = myFrame; }
      myReplaceIndex[myID] = (mySlot + 1) % myMaxBuffer;
      document.getElementById('myDivHistory').innerHTML = `Trained ${document.getElementById('myLabel'+myID).value} (Slot ${mySlot + 1})<br>` + document.getElementById('myDivHistory').innerHTML;
    }

    async function mySaveModel() { 
        if(!myModel) return;
        await myModel.save('downloads://my-tfjs-model');
    }

    async function myLoadModel() {
        const myU = document.createElement('input'); myU.type = 'file'; myU.multiple = true;
        myU.onchange = async (e) => { 
            myModel = await tf.loadLayersModel(tf.io.browserFiles(e.target.files));
            document.getElementById('myDivHistory').innerHTML = "Model Loaded!<br>" + document.getElementById('myDivHistory').innerHTML;
        };
        myU.click();
    }

    (async function() {
      const myDevices = await navigator.mediaDevices.enumerateDevices();
      const mySelect = document.getElementById('myCameraSelect');
      myDevices.filter(d => d.kind === 'videoinput').forEach((d, i) => {
        const myOpt = document.createElement('option');
        myOpt.value = d.deviceId;
        myOpt.text = d.label || `Camera ${i + 1}`;
        mySelect.appendChild(myOpt);
      });
    })();
  </script>
</div>
</body>
</html>
