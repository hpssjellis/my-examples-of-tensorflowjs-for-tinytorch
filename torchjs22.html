<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>

<body>

<h2 align="center">torchjs22.html - Stable Model Quantization</h2>

<div style="font-size:15px; background-color:lightyellow; width:88%; border:5px solid blue; padding:5px; margin:5px;"> 
<b>Compression Logic:</b> Large numbers take up too much space. We "Quantize" (round) them to save memory. 
Move the slider to see the <b>Memory Size</b> drop, but watch out for the <b>Accuracy</b>!
</div><br>

<div id="myCodeSpace">
  <div style="display: flex; gap: 20px; padding: 10px; flex-wrap: wrap;">
    
    <div style="flex: 1; min-width: 300px; border: 2px solid green; padding: 10px;">
      <b>1. Precision Control:</b><br>
      <input type="range" id="mySlider" min="1" max="32" value="32" style="width: 80%;" oninput="myQuantize()">
      <span id="myBits" style="font-weight:bold;">32</span> bits<br><br>
      
      <b>Model Memory Size:</b> 
      <div id="mySize" style="font-size: 24px; color: red; font-weight: bold;">4.0 MB</div>
    </div>

    <div style="flex: 1.5; min-width: 300px; border: 2px solid blue; padding: 10px;">
      <b>2. Quantized Weights (Sample):</b><br>
      <div id="myWeightBox" style="font-family: monospace; font-size: 12px; background: #eee; padding: 10px; height: 120px; overflow-y: scroll; border: 1px inset gray;">
        Generating...
      </div>
    </div>
  </div>

  <div id="myDivHistory" style="border: 2px solid orange; padding: 10px; margin: 10px; font-family: monospace; background-color: #fff4e6; min-height: 80px;">
    Quantization results will appear here...
  </div>

  <script>
    // Original high-precision weights (Float32)
    var myOriginalWeights = [0.12345678, -0.98765432, 0.45612378, -0.22233344, 0.88877766, -0.11122233];

    function myQuantize() {
      const myBits = parseInt(document.getElementById('mySlider').value);
      const myBitLabel = document.getElementById('myBits');
      const mySizeDisplay = document.getElementById('mySize');
      const myWeightBox = document.getElementById('myWeightBox');
      const myHistory = document.getElementById('myDivHistory');

      myBitLabel.innerHTML = myBits;

      // 1. Calculate Simulated Memory Size (Full model = 1,000,000 weights)
      // (1,000,000 weights * bits) / 8 / 1024 / 1024 = MB
      const myMB = ((1000000 * myBits) / 8 / 1024 / 1024).toFixed(2);
      mySizeDisplay.innerHTML = myMB + " MB";
      mySizeDisplay.style.color = myBits < 9 ? "green" : "red";

      // 2. Quantization Math (Simulating bit-depth reduction)
      const mySteps = Math.pow(2, myBits);
      let myNewWeights = [];
      
      myOriginalWeights.forEach(w => {
         // This is the core quantization formula
         let myQuantized = Math.round(w * (mySteps/2)) / (mySteps/2);
         myNewWeights.push(myQuantized.toFixed(myBits < 10 ? 3 : 6));
      });

      myWeightBox.innerHTML = "<b>Float32 Weights converted to " + myBits + "-bit:</b><br><br>" + myNewWeights.join(", <br>");

      // 3. Performance impact logic
      let myAcc = 99.2;
      if (myBits < 16) myAcc -= (16 - myBits) * 0.5;
      if (myBits < 6) myAcc -= (6 - myBits) * 15;
      if (myAcc < 10) myAcc = 10.0; // Random guess baseline

      myHistory.innerHTML = `<b>Compression Report:</b><br>
        Bit Precision: ${myBits}-bit<br>
        Estimated AI Accuracy: <b style="color:${myAcc < 70 ? 'red' : 'green'}">${myAcc.toFixed(1)}%</b><br>
        Hardware Compatibility: ${myBits <= 8 ? '✅ Ready for ESP32' : '⚠️ Too Large for Tiny Chips'}`;
      
      // Cleanup for memory safety in students' browsers
      const myDummyTensor = tf.tensor1d(myNewWeights.map(Number));
      myDummyTensor.dispose();
    }
  </script>
</div>

<input id="myUpdateBtn" type="button" value="Update and Run" style="visibility:hidden; background-color: yellow;" onclick="myApplyAndRun()"><br>

<textarea id="myTextarea1" wrap="off" rows="2" style="width:95%; background:black; color:white; font-family:monospace; margin:10px;" onclick="myToggleEditor()">
Click here to see the Quantization math...
</textarea>

<script>
let myOnce = true;

function myToggleEditor() {
    if (myOnce) {
       myTextGrow('myTextarea1', 'myCodeSpace');
       document.getElementById('myUpdateBtn').style.visibility = 'visible';
       myOnce = false;
    }
}

function myApplyAndRun() {
  let myLines = document.getElementById('myTextarea1').value.split('\n');
  myLines.shift(); // Remove script
  myLines.shift(); // Remove spacer
  myLines.pop();   // Remove div
  
  document.getElementById('myCodeSpace').innerHTML = myLines.join('\n');
  myQuantize(); 
}

function myTextGrow(myT, myC) {
   const myArea = document.getElementById(myT);
   myArea.value = '\x3Cscript src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0">\x3C/script>\n\n' + document.getElementById(myC).innerHTML;
   myArea.value += "\n<div id='myDivHistory'>...</div>";
   setTimeout(() => { myArea.rows = myArea.value.split('\n').length + 3; }, 100);
}

window.onload = myQuantize;
</script>

</body>