<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>

<body>

<h2 align="center">torchjs21.html - Stable Probability Engine</h2>

<div style="font-size:15px; background-color:lightyellow; width:88%; border:5px solid blue; padding:5px; margin:5px;"> 
<b>The Choice:</b> Large Language Models use probability to pick words. 
Edit the <b>Weights</b> in the blue box to change the robot's mood, then click <b>Update and Run</b> to see the AI generate a new ending!
</div><br>

<div id="myCodeSpace">
  <div style="display: flex; gap: 20px; padding: 10px; flex-wrap: wrap;">
    
    <div style="flex: 1.2; min-width: 350px; border: 2px solid green; padding: 10px;">
      <b>1. Start the Chain:</b><br>
      <input type="text" id="myInputText" value="The robot is" style="width: 60%; font-size: 18px;">
      <input type="button" value="GENERATE" onclick="myRunTransformer()">
      
      <div id="myOutputDisplay" style="font-size: 30px; margin-top: 20px; color: #2c3e50; font-family: 'Courier New', Courier, monospace;">
        The robot is...
      </div>
    </div>

    <div style="flex: 1; min-width: 300px; border: 2px solid blue; padding: 10px;">
      <b>2. Probability Weights (JSON):</b><br>
      <textarea id="myWeightsJSON" rows="8" style="width: 95%; font-family: monospace;" oninput="myDrawBrain()">
{
  "happy": 0.50,
  "sad": 0.10,
  "angry": 0.05,
  "thinking": 0.20,
  "broken": 0.15
}
      </textarea>
    </div>
  </div>

  <div id="myDivHistory" style="border: 2px solid orange; padding: 10px; margin: 10px; font-family: monospace; background-color: #fff4e6; min-height: 80px;">
    AI Decision Logic will appear here...
  </div>

  <script>
    function myRunTransformer() {
      const myText = document.getElementById('myInputText').value;
      const myDisplay = document.getElementById('myOutputDisplay');
      const myHistory = document.getElementById('myDivHistory');
      const myJSONArea = document.getElementById('myWeightsJSON');
      
      try {
        const myProbabilities = JSON.parse(myJSONArea.value);
        const myWords = Object.keys(myProbabilities);
        const myWeights = Object.values(myProbabilities);
        
        // 1. Create the Tensor (simulating the final layer of a Transformer)
        const myTensor = tf.tensor1d(myWeights);
        
        // 2. Random Sampling (The "Temperature" or Sampling step)
        const myRandom = Math.random();
        let myCumulative = 0;
        let myChosenWord = "???";

        for (let i = 0; i < myWeights.length; i++) {
          myCumulative += myWeights[i];
          if (myRandom < myCumulative) {
            myChosenWord = myWords[i];
            break;
          }
        }

        // 3. UI Updates
        myDisplay.innerHTML = `${myText} <span style="color:red;">${myChosenWord}</span>`;
        myHistory.innerHTML = `<b>AI Decision Logic:</b><br>
          Random Number Generated: ${myRandom.toFixed(3)}<br>
          Chosen Word: <b>${myChosenWord}</b> (Confidence: ${(myProbabilities[myChosenWord]*100).toFixed(0)}%)<br>
          Output Tensor: [${myWeights.join(", ")}]`;

        myTensor.dispose();
      } catch(e) {
        myHistory.innerHTML = "<b style='color:red;'>JSON Syntax Error! Check your commas.</b>";
      }
    }

    function myDrawBrain() {
       // Visual feedback for JSON validation
       try { 
         JSON.parse(document.getElementById('myWeightsJSON').value); 
         document.getElementById('myWeightsJSON').style.backgroundColor = "white";
       } catch(e) {
         document.getElementById('myWeightsJSON').style.backgroundColor = "#ffcccc";
       }
    }
  </script>
</div>

<input id="myUpdateBtn" type="button" value="Update and Run" style="visibility:hidden; background-color: yellow;" onclick="myApplyAndRun()"><br>

<textarea id="myTextarea1" wrap="off" rows="2" style="width:95%; background:black; color:white; font-family:monospace; margin:10px;" onclick="myToggleEditor()">
Click here to see how the AI picks the next word...
</textarea>

<script>
let myOnce = true;

function myToggleEditor() {
    if (myOnce) {
       myTextGrow('myTextarea1', 'myCodeSpace');
       document.getElementById('myUpdateBtn').style.visibility = 'visible';
       myOnce = false;
    }
}

function myApplyAndRun() {
  let myLines = document.getElementById('myTextarea1').value.split('\n');
  myLines.shift(); // Remove script src
  myLines.shift(); // Remove spacer
  myLines.pop();   // Remove div wrapper
  
  document.getElementById('myCodeSpace').innerHTML = myLines.join('\n');
  myRunTransformer(); 
}

function myTextGrow(myT, myC) {
   const myArea = document.getElementById(myT);
   myArea.value = '\x3Cscript src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0">\x3C/script>\n\n' + document.getElementById(myC).innerHTML;
   myArea.value += "\n<div id='myDivHistory'>...</div>";
   setTimeout(() => { myArea.rows = myArea.value.split('\n').length + 3; }, 100);
}

window.onload = myRunTransformer;
</script>

</body>