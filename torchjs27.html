<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>

<body style="font-family: sans-serif; background-color: #fdfdfd;">

<h2 align="center">Rocksetta Pro: Fast 20-Slot Optimizer</h2>

<div style="font-size:14px; background-color:lightyellow; width:92%; border:2px solid blue; padding:15px; margin:auto; border-radius:10px;"> 
<b>Agile Learning:</b> We are back to a <b>20-frame buffer</b> for faster re-training. 
<br><b>Important:</b> If you reduce pruning, you must train until the "Slot" count cycles to refresh the weights.
</div><br>

<div id="myCodeSpace"> 
  <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; padding: 10px;">
    
    <div style="flex: 1; min-width: 330px; border: 1px solid #ccc; padding: 15px; background: white; border-radius: 10px;">
      <select id="myCameraSelect" style="width: 100%; margin-bottom: 5px;"></select>
      <video id="myVideo1" width="320" height="240" autoplay playsinline style="border: 2px solid black; background: #000; border-radius: 5px;"></video>
      <br><br>
      <input type="button" value="1. Start Camera & Brain" onclick="myStartAll()" style="width:100%; font-weight:bold; padding:10px; background:#e1f5fe; cursor:pointer;">
      <hr>
      <b>Training & Labels:</b><br>
      <div style="display: flex; justify-content: space-between; margin-top:5px; text-align:center; font-size:12px;">
        <div><input type="button" value="Train 0" onclick="myCollect(0)"><br><input type="text" id="myLabel0" value="Background" size="9" style="text-align:center"></div>
        <div><input type="button" value="Train 1" onclick="myCollect(1)"><br><input type="text" id="myLabel1" value="Hand" size="9" style="text-align:center"></div>
        <div><input type="button" value="Train 2" onclick="myCollect(2)"><br><input type="text" id="myLabel2" value="Face" size="9" style="text-align:center"></div>
      </div>
    </div>

    <div style="flex: 1; min-width: 330px; border: 2px solid green; padding: 15px; background: #f1f8e9; border-radius: 10px;">
      <b>2. Edge AI Optimization</b><hr>
      <b>Pruning Threshold:</b><br>
      <input type="range" id="myPruneSlider" min="0" max="95" value="10" style="width:80%" oninput="myPruneCheck()">
      <span id="myPruneVal">10</span>% Cut
      <div id="myTrainReminder" style="color:red; font-size:11px; display:none; font-weight:bold; margin-top:5px;">⚠️ THRESHOLD LOWERED: RE-TRAIN SLOTS!</div>
      <br><br>
      <b>Quantization:</b> <b style="color:green;">Int8 (Professional)</b>
      <hr>
      <b>Export Name:</b><br>
      <input type="text" id="myExportName" value="myModelData" style="width:70%"> .h
      <br><br>
      <input type="button" value="EXPORT BINARY (.h)" style="background-color:#4CAF50; color:white; width:100%; padding:10px; font-weight:bold; cursor:pointer;" onclick="myExportBinary()">
    </div>

    <div style="flex: 1; min-width: 330px; border: 1px solid #ccc; padding: 15px; background: white; border-radius: 10px;">
      <b>3. Output & Logs</b><hr>
      <div id="myDiv1" style="border: 1px solid green; padding: 10px; font-family: monospace; background: #e8f5e9; min-height: 50px;">Ready...</div>
      <hr>
      <div id="myDivHistory" style="border: 1px solid blue; padding: 5px; height: 120px; overflow-y: scroll; font-family: monospace; font-size: 0.8em; background: #f1f8ff;">Logs...</div>
    </div>
  </div>

  <script>
    var myModel, myTimer, myLastID = -1;
    var myTrainData = {0:[], 1:[], 2:[]};
    var myReplaceIndex = {0:0, 1:0, 2:0}; 
    var myPrevPrune = 10;
    var myMaxBuffer = 20; // Back to 20 for faster response

    function myPruneCheck() {
      let myCurrent = document.getElementById('myPruneSlider').value;
      document.getElementById('myPruneVal').innerText = myCurrent;
      if (parseInt(myCurrent) < myPrevPrune) {
        document.getElementById('myTrainReminder').style.display = 'block';
      } else {
        document.getElementById('myTrainReminder').style.display = 'none';
      }
      myPrevPrune = parseInt(myCurrent);
    }

    async function myStartAll() {
      const myVideo = document.getElementById('myVideo1');
      if (!myVideo.srcObject) {
        const myDeviceId = document.getElementById('myCameraSelect').value;
        myVideo.srcObject = await navigator.mediaDevices.getUserMedia({video: { deviceId: myDeviceId ? { exact: myDeviceId } : undefined }});
      }
      if (!myModel) {
        myModel = tf.sequential();
        myModel.add(tf.layers.conv2d({inputShape:[64,64,3], kernelSize:3, filters:4, activation:'relu'}));
        myModel.add(tf.layers.flatten());
        myModel.add(tf.layers.dense({units:3, activation:'softmax'}));
        myModel.compile({optimizer: tf.train.adam(0.005), loss:'categoricalCrossentropy'});
      }
      if (myTimer) clearInterval(myTimer);
      myTimer = setInterval(async () => {
        const myInput = tf.browser.fromPixels(myVideo).resizeBilinear([64,64]).div(255.0).expandDims(0);
        
        if (myTrainData[0].length > 0 && myTrainData[1].length > 0 && myTrainData[2].length > 0) {
          const myBatch = tf.concat([
            myTrainData[0][Math.floor(Math.random()*myTrainData[0].length)],
            myTrainData[1][Math.floor(Math.random()*myTrainData[1].length)],
            myTrainData[2][Math.floor(Math.random()*myTrainData[2].length)]
          ]);
          await myModel.trainOnBatch(myBatch, tf.tensor2d([[1,0,0],[0,1,0],[0,0,1]]));
          myBatch.dispose();
          document.getElementById('myTrainReminder').style.display = 'none';
        }

        const myPred = myModel.predict(myInput);
        const myID = (await myPred.argMax(1).data())[0];
        const myLabel = document.getElementById('myLabel' + myID).value;
        document.getElementById('myDiv1').innerHTML = `DETECTED: <b>${myLabel}</b><br>Buffers: ${myTrainData[0].length}, ${myTrainData[1].length}, ${myTrainData[2].length}`;
        
        if (myID !== myLastID) {
          document.getElementById('myDivHistory').innerHTML = `[${new Date().toLocaleTimeString()}] -> ${myLabel}<br>` + document.getElementById('myDivHistory').innerHTML;
          myLastID = myID;
        }
        myInput.dispose(); myPred.dispose();
      }, 200);
    }

    async function myExportBinary() {
      const myThreshold = document.getElementById('myPruneSlider').value / 100;
      const myFileName = document.getElementById('myExportName').value + ".h";
      let myTotalBytes = [];
      for (let myL of myModel.layers) {
        if (myL.getWeights().length > 0) {
          let myW = await myL.getWeights()[0].data();
          // Int8 Quantization with Pruning
          const myBinary = Int8Array.from(myW, v => Math.abs(v) < myThreshold ? 0 : Math.round(v * 127));
          myTotalBytes.push(...new Uint8Array(myBinary.buffer));
        }
      }
      let myHex = myTotalBytes.map(b => '0x' + b.toString(16).padStart(2, '0')).join(', ');
      let myText = `#ifndef MY_MODEL_DATA_H\n#define MY_MODEL_DATA_H\n\n`;
      myText += `alignas(16) const unsigned char myModelData[] = {\n  ${myHex}\n};\n\n`;
      myText += `const unsigned int myModelLen = ${myTotalBytes.length};\n\n#endif`;
      const myLink = document.createElement('a');
      myLink.href = URL.createObjectURL(new Blob([myText]));
      myLink.download = myFileName;
      myLink.click();
    }

    function myCollect(myID) {
      const myVideo = document.getElementById('myVideo1');
      const myFrame = tf.browser.fromPixels(myVideo).resizeBilinear([64,64]).div(255.0).expandDims(0);
      
      let mySlot = myReplaceIndex[myID];
      
      if (myTrainData[myID].length < myMaxBuffer) {
        myTrainData[myID].push(myFrame);
      } else {
        myTrainData[myID][mySlot].dispose(); 
        myTrainData[myID][mySlot] = myFrame;
      }
      
      const myName = document.getElementById('myLabel' + myID).value;
      document.getElementById('myDivHistory').innerHTML = `Added to ${myName} (Slot: ${mySlot + 1} of ${myMaxBuffer})<br>` + document.getElementById('myDivHistory').innerHTML;
      
      myReplaceIndex[myID] = (mySlot + 1) % myMaxBuffer;
    }
  </script>
</div>

<div align="center">
  <input id="myUpdateBtn" type="button" value="Update & Run" style="visibility:hidden; background-color: yellow; font-weight:bold; padding:12px; border-radius:8px; cursor:pointer;" onclick="myApplyAndRun()">
</div>

<textarea id="myTextarea1" wrap="off" rows="2" style="width:95%; background:black; color:white; font-family:monospace; margin:15px; padding:10px; border-radius:10px;" onclick="myToggleEditor()">
Click here to see the Source Code...
</textarea>

<script>
let myOnce = true;
function myToggleEditor() {
    if (myOnce) {
       myTextGrow('myTextarea1', 'myCodeSpace');
       document.getElementById('myUpdateBtn').style.visibility = 'visible';
       myOnce = false;
    }
}
function myApplyAndRun() {
  let myLines = document.getElementById('myTextarea1').value.split('\n');
  myLines.shift(); myLines.shift(); myLines.pop();   
  document.getElementById('myCodeSpace').innerHTML = myLines.join('\n');
  myStartAll();
}
function myTextGrow(myT, myC) {
   const myArea = document.getElementById(myT);
   myArea.value = '\x3Cscript src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0">\x3C/script>\n\n' + document.getElementById(myC).innerHTML;
   myArea.rows = 20;
}
(async function init() {
  const myDevices = await navigator.mediaDevices.enumerateDevices();
  const mySelect = document.getElementById('myCameraSelect');
  myDevices.filter(d => d.kind === 'videoinput').forEach((d, i) => {
    const myOpt = document.createElement('option');
    myOpt.value = d.deviceId;
    myOpt.text = d.label || `Camera ${i + 1}`;
    mySelect.appendChild(myOpt);
  });
})();
</script>

</body>