<!DOCTYPE html>
<html>
<head>
    <title>Rocksetta Pro: Master Optimizer</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>
</head>
<body style="font-family: sans-serif; background-color: #fdfdfd; padding: 10px;">

<h2 align="center">Rocksetta Pro: Master Optimizer (Anti-Overflow Edition)</h2>

<div id="myCodeSpace"> 
  <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; padding: 10px;">
    
    <div style="flex: 1; min-width: 350px; border: 1px solid #ccc; padding: 15px; background: white; border-radius: 10px;">
      <select id="myCameraSelect" style="width: 100%; margin-bottom: 5px;"></select>
      <div align="center">
          <video id="myVideo1" width="240" height="240" autoplay playsinline style="border: 2px solid black; background: #000; border-radius: 5px;"></video>
      </div>
      <br>
      <input type="button" value="1. Start Camera & Brain" onclick="myStartAll()" style="width:100%; font-weight:bold; padding:12px; background:#e1f5fe; border-radius: 5px; cursor:pointer;">
      <hr>
      <div style="display: flex; justify-content: space-between;">
          <input type="button" value="Save TFJS" onclick="mySaveModel()" style="width:48%;">
          <input type="button" value="Load TFJS" onclick="myLoadModel()" style="width:48%;">
      </div>
      <hr>
      <b>Training:</b><br>
      <div style="display: flex; justify-content: space-between; margin-top:5px; text-align:center;">
        <div>
          <input type="button" value="Train 0" onclick="myCollect(0)" style="background:#ffebee;">
          <br><input type="text" id="myLabel0" value="Rock" size="8">
          <br><span id="myCount0" style="font-size:11px; color:#666;">0 samples</span>
        </div>
        <div>
          <input type="button" value="Train 1" onclick="myCollect(1)" style="background:#e8f5e9;">
          <br><input type="text" id="myLabel1" value="Paper" size="8">
          <br><span id="myCount1" style="font-size:11px; color:#666;">0 samples</span>
        </div>
        <div>
          <input type="button" value="Train 2" onclick="myCollect(2)" style="background:#e3f2fd;">
          <br><input type="text" id="myLabel2" value="Scissor" size="8">
          <br><span id="myCount2" style="font-size:11px; color:#666;">0 samples</span>
        </div>
      </div>
    </div>

    <div style="flex: 1; min-width: 350px; border: 2px solid green; padding: 15px; background: #f1f8e9; border-radius: 10px;">
      <b>2. Edge AI Export (ESP32)</b><hr>
      <label style="font-weight: bold; color: darkgreen; cursor: pointer;">
        <input type="checkbox" id="myInt8Toggle"> Use Int8 Quantization
      </label>
      <p style="font-size: 11px;">(Reduces .h file size significantly)</p>
      <b>Export Name:</b><br>
      <input type="text" id="myExportName" value="myModel" style="width:70%;"> .h
      <br><br>
      <input type="button" value="GENERATE (.h)" style="background-color:#4CAF50; color:white; width:100%; padding:15px; font-weight:bold; border-radius: 5px; cursor:pointer;" onclick="myExportHeader()">
      <hr>
      <div id="myOutputDisplay" style="border: 1px solid green; padding: 10px; background: white; min-height: 50px; border-radius:5px;">
        Click Start to begin...
      </div>
    </div>

    <div style="flex: 1; min-width: 350px; border: 1px solid #ccc; padding: 15px; background: white; border-radius: 10px;">
      <b>3. Activity Logs</b><hr>
      <div id="myDivHistory" style="border: 1px solid blue; padding: 8px; height: 300px; overflow-y: scroll; font-family: monospace; font-size: 0.85em; background: #f1f8ff; border-radius: 5px;">
        System Idle...
      </div>
    </div>
  </div>

  <script>
    var myModel, myTimer;
    var myTrainData = {0:[], 1:[], 2:[]};
    var myMaxBuffer = 100;

    function myLog(myMsg) {
        const myDiv = document.getElementById('myDivHistory');
        const myTime = new Date().toLocaleTimeString();
        myDiv.innerHTML = `[${myTime}] ${myMsg}<br>` + myDiv.innerHTML;
    }

    // DATA AUGMENTATION: Prevents the model from being too rigid
    function myAugment(tensor) {
      return tf.tidy(() => {
        let augmented = tensor;
        if (Math.random() > 0.5) {
          const brightness = (Math.random() - 0.5) * 0.2;
          augmented = augmented.add(brightness).clipByValue(0, 1);
        }
        return augmented;
      });
    }

    async function myStartAll() {
      const myVideo = document.getElementById('myVideo1');
      if (!myVideo.srcObject) {
        const myDeviceId = document.getElementById('myCameraSelect').value;
        myVideo.srcObject = await navigator.mediaDevices.getUserMedia({
            video: { width: 240, height: 240, deviceId: myDeviceId ? { exact: myDeviceId } : undefined }
        });
        myLog("Camera Started");
      }

      if (!myModel) {
        myModel = tf.sequential();
        // Layer 1: Detects shapes
        myModel.add(tf.layers.conv2d({inputShape:[64,64,3], kernelSize:3, filters:4, activation:'relu'}));
        myModel.add(tf.layers.maxPooling2d({poolSize:2, strides:2}));
        // Layer 2: Patterns
        myModel.add(tf.layers.conv2d({kernelSize:3, filters:8, activation:'relu'}));
        
        // THE OVF FIX: Global Average Pooling instead of Flatten
        // This makes the ESP32 logic iterate 8 times instead of 6728.
        myModel.add(tf.layers.globalAveragePooling2d());
        
        myModel.add(tf.layers.dense({units:3, activation:'softmax'}));
        myModel.compile({optimizer: tf.train.adam(0.005), loss:'categoricalCrossentropy'});
        myLog("Brain Ready: Using Global Average Pooling");
      }

      if (myTimer) clearInterval(myTimer);
      myTimer = setInterval(async () => {
        tf.tidy(() => {
            const myInput = tf.browser.fromPixels(myVideo).resizeBilinear([64,64]).div(255.0).expandDims(0);
            
            // 1. Prediction (Always runs)
            const myPred = myModel.predict(myInput);
            myPred.data().then(myProbs => {
                const myID = myProbs.indexOf(Math.max(...myProbs));
                const conf = (myProbs[myID] * 100).toFixed(0);
                const labelName = document.getElementById('myLabel'+myID).value;
                
                document.getElementById('myOutputDisplay').innerHTML = 
                  `DETECTED: <b style="color:blue;">${labelName}</b> (${conf}%)<br>` +
                  `<div style="background:#eee; width:100%; height:10px; border-radius:5px; margin-top:5px;">` +
                  `<div style="background:blue; width:${conf}%; height:10px; border-radius:5px;"></div></div>`;
            });

            // 2. Training (Only if we have data)
            if (myTrainData[0].length > 0 && myTrainData[1].length > 0 && myTrainData[2].length > 0) {
              let myBatch = [];
              let myLabels = [];
              for (let b = 0; b < 6; b++) {
                const cls = b % 3;
                const rIdx = Math.floor(Math.random() * myTrainData[cls].length);
                const sample = myTrainData[cls][rIdx];
                myBatch.push(Math.random() > 0.5 ? myAugment(sample) : sample);
                myLabels.push(cls === 0 ? [1,0,0] : cls === 1 ? [0,1,0] : [0,0,1]);
              }
              const bx = tf.concat(myBatch);
              const by = tf.tensor2d(myLabels);
              myModel.trainOnBatch(bx, by);
            }
        });
      }, 100);
    }

    async function myExportHeader() {
      if(!myModel) return;
      const myIsInt8 = document.getElementById('myInt8Toggle').checked;
      let myText = `// AI Model for ESP32 - Generated via Rocksetta Pro\n`;
      myText += `#ifndef MY_MODEL_H\n#define MY_MODEL_H\n\n`;
      
      // Export class labels for the ESP32 code to use
      const l0 = document.getElementById('myLabel0').value;
      const l1 = document.getElementById('myLabel1').value;
      const l2 = document.getElementById('myLabel2').value;
      myText += `const char* myLabels[] = {"${l0}", "${l1}", "${l2}"};\n\n`;

      if (myIsInt8) { myText += `#define USE_INT8_MODE\n\n`; }
      
      const myNames = ["myConv1_w", "myConv1_b", "myConv2_w", "myConv2_b", "myOutput_w", "myOutput_b"];
      let nameIdx = 0;
      
      for (let layer of myModel.layers) {
          if (layer.getWeights().length === 0) continue;
          for (let weight of layer.getWeights()) {
              let data = await weight.data();
              if (myIsInt8) {
                  const maxV = Math.max(...Array.from(data).map(Math.abs));
                  const scale = 127.0 / (maxV || 1);
                  myText += `const float ${myNames[nameIdx]}_scale = ${scale.toFixed(6)}f;\n`;
                  myText += `const int8_t ${myNames[nameIdx]}[] = { ${Array.from(data).map(v => Math.round(v * scale)).join(', ')} };\n\n`;
              } else {
                  myText += `const float ${myNames[nameIdx]}[] = { ${Array.from(data).map(v => v.toFixed(6)).join(', ')} };\n\n`;
              }
              nameIdx++;
          }
      }
      myText += `#endif`;
      const link = document.createElement('a');
      link.href = URL.createObjectURL(new Blob([myText]));
      link.download = document.getElementById('myExportName').value + ".h";
      link.click();
      myLog("Header Exported Successfully");
    }

    function myCollect(id) {
      const vid = document.getElementById('myVideo1');
      const frame = tf.tidy(() => tf.browser.fromPixels(vid).resizeBilinear([64,64]).div(255.0).expandDims(0));
      if (myTrainData[id].length < myMaxBuffer) {
        myTrainData[id].push(frame);
      } else {
        myTrainData[id][0].dispose();
        myTrainData[id].shift();
        myTrainData[id].push(frame);
      }
      document.getElementById('myCount'+id).innerHTML = `${myTrainData[id].length} samples`;
    }

    async function mySaveModel() { await myModel.save('downloads://my-tfjs-model'); }
    async function myLoadModel() {
        const u = document.createElement('input'); u.type='file'; u.multiple=true;
        u.onchange = async (e) => { myModel = await tf.loadLayersModel(tf.io.browserFiles(e.target.files)); myLog("Model Loaded"); };
        u.click();
    }
  </script>
</div>
</body>
</html>
